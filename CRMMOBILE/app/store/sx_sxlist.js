/*
 * File: app/store/sx_sxlist.js
 *
 * This file was generated by Sencha Architect version 3.5.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('liftnet.store.sx_sxlist', {
    extend: 'Ext.data.Store',

    requires: [
        'Ext.data.Field'
    ],

    config: {
        storeId: 'sx_sxlist',
        fields: [
            {
                name: 'operdate',
                type: 'string'
            },
            {
                name: 'istrap',
                type: 'string'
            },
            {
                name: 'trno',
                type: 'string'
            },
            {
                name: 'projectname',
                type: 'string'
            },
            {
                name: 'addr',
                type: 'string'
            },
            {
                name: 'checkuser',
                type: 'string'
            },
            {
                name: 'state',
                type: 'string'
            },
            {
                name: 'nextstate',
                type: 'auto'
            },
            {
                name: 'titleIcon',
                type: 'string'
            },
            {
                name: 'titleColor',
                type: 'string'
            },
            {
                name: 'urgent',
                type: 'string'
            },
            {
                name: 'statusColor',
                type: 'string'
            }
        ]
    },

    loadDat: function(onSuccess, onFailure, parm, action) {
        var me = this;
        // this.setData([]);
        //console.log(JsonUtil.convertToString(parm));
        if(global.isWorklight()) {
            var url = '/adapters/shouxin/api/1.0/mobiletrrequest';
            callPostAdapter(
                url, parm,
                function(ret) {
                    var info;
                    if(ret.status.code!=200){
                        if(parm.searchkey!==''){
                            onFailure('搜索故障受信列表失败');
                            return;
                        }
                        onFailure('读取故障受信列表失败');
                    }else{
                        if(ret.data.length===0){
                            if(parm.curpagenum===1){
                                switch(action){
                                    case 'refresh':
                                        info = '没有故障受信数据';
                                        break;
                                    case 'loadmore':
                                        break;
                                    case 'firstload':
                                        info = '没有故障受信数据';
                                        break;
                                    case 'search':
                                        info = '没有相关故障受信数据';
                                        break;
                                }
                                me.setData(ret.data);
                                onFailure(info);
                            }else{
                                onFailure('没有更多数据！');
                            }
                            return;
                        }

                        var d = me.decoDat(ret.data);
                        //第一次加载直接设置数据
                        if(parm.curpagenum==1){
                            me.setData(ret.data);
                        }else{
                            //分页用法，在原有数据上继续添加
                            var n = d.length;
                            for(var i=0; i<n; i++) {
                                me.add(d[i]);
                            }
                        }

                        if(action==='loadmore'){
                            onSuccess(d.length,ret.jurisdiction);
                        }else{
                            onSuccess('resetCurPage',ret.jurisdiction);
                        }
                    }
                },
                function() {
                    var info;
                    switch(action){
                        case 'refresh':
                            info = '刷新故障受信数据失败';
                            break;
                        case 'loadmore':
                            info = '加载更多故障受信数据失败';
                            break;
                        case 'firstload':
                            info = '获取故障受信数据失败';
                            break;
                        case 'search':
                            info = '搜索故障受信失败';
                            break;
                    }
                    onFailure(info);
        //             if(parm.searchkey!==''){
        //                 onFailure('搜索故障受信列表失败');
        //                 return;
        //             }
        //             onFailure('读取故障受信列表失败');
                }
            );
            //         function(ret) {
            //             var d = me.decoDat(ret.data);
            //             me.setData(d);
            //             onSuccess(d.length);
            //         },
            //         onFailure);
        } else {
            //分页模拟
            var start = (parm.curpagenum-1)*20,
                end = parm.curpagenum * parm.pagesize;
            //         end = end>50?50:end;
            if(end>60){
                onFailure('没有更多数据！');
                return;
            }

            for(var i=start; i<end; i++) {
                if(i%2==1){
                    this.add({
                        trno: 'BX20150604043',
                        operdate:'projectid'+(i),
                        istrap:1,
                        projectname: '广州市华越友联科技发展有限公司.' + (i + 1),
                        addr: '广州市荔湾区黄沙大道144号大冶有色大厦1001室',
                        state: '未接收',
                        nextstate:[
                            {name:'接收'},
                            {name:'退回'},
                            {name:'转派'},
                        ]
                    });
                }else{
                    this.add({
                        trno: 'BX20150604043',
                        operdate:'projectid'+(i),
                        istrap:1,
                        projectname: '广州市华越友联科技发展有限公司.' + (i + 1),
                        addr: '广州市荔湾区黄沙大道144号大冶有色大厦1001室',
                        state: '维修中',
                        nextstate:[{
                            name:'完工'
                        }]
                    });
                }
            }
            if(action=='firstload'||action=='refresh'||action=='search'){
                onSuccess('resetCurPage',{
                    addjurisdiction	:	'Y',	//新建权限（Y/N）,
                    updatejurisdiction	: 'Y'		//修改权限（Y/N）

                });
                return;
            }
            // 演示数据
        //     onSuccess(end - start + 1);
            onSuccess(end - start + 1);
        //     var d = this.decoDat([
        //         {
        //             operdate: '2015-12-01&nbsp;21:25',
        //             istrap: '1',
        //             state: '待分配',
        //             trno: 'BX20150604043',
        //             projectname: '粤商投资有限公司2',
        //             addr: '广州市白云区人和龙苑小区2',
        //             checkuser:'',
        //             nextstate: [
        //                         {name:"删除",url:"http://127.0.0.1/删除"}
        //                     ],
        //             urgent: '',
        //             statusColor: '',
        //             titleIcon: '',
        //             titleColor: '',
        //         },
        //         {
        //             operdate: '2015-12-01&nbsp;21:25',
        //             istrap: '1',
        //             state: '未接收',
        //             trno: 'BX20150604043',
        //             projectname: '粤商投资有限公司2',
        //             addr: '广州市白云区人和龙苑小区2',
        //             checkuser:'',
        //             nextstate: [
        //                 {name:"接收",url:"http://127.0.0.1/接收"},
        //                 {name:"退回",url:"http://127.0.0.1/退回"},
        //                 {name:"转派",url:"http://127.0.0.1/转派"}
        //             ],
        //             urgent: '',
        //             statusColor: '',
        //             titleIcon: '',
        //             titleColor: '',
        //         },
        //         {
        //             operdate: '2015-12-01&nbsp;11:55',
        //             istrap: '0',
        //             state: '已完工',
        //             trno: 'BX2015060405',
        //             projectname: '广州市粤商投资有限公司',
        //             addr: '广州市白云区人和龙苑小区',
        //             checkuser:'陈大福',
        //             nextstate: [],
        //             urgent: '',
        //             statusColor: '',
        //             titleIcon: '',
        //             titleColor: '',
        //         },
        //         {
        //             operdate: '2015-12-01&nbsp;11:55',
        //             istrap: '1',
        //             state: '已退回',
        //             trno: 'BX2015060406',
        //             projectname: '广州市粤商投资有限公司',
        //             addr: '广州市白云区人和龙苑小区',
        //             checkuser:'陈大福',
        //             nextstate: [
        //                 {name:"转派",url:"http://127.0.0.1/转派"},
        //                 {name:"删除",url:"http://127.0.0.1/删除"}
        //             ],
        //             taskid: 'TASK123456',
        //             url: '查询明细url',
        //             urgent: '',
        //             statusColor: '',
        //             titleIcon: '',
        //             titleColor: '',
        //         },
        //         {
        //             operdate: '2015-12-01&nbsp;21:25',
        //             istrap: '1',
        //             state: '未接收',
        //             trno: 'BX2015060404',
        //             projectname: '广州市粤商投资有限公司',
        //             addr: '广州市白云区人和龙苑小区',
        //             checkuser:'',
        //             nextstate: [
        //                 {name:"接收",url:"http://127.0.0.1/接收"},
        //                 {name:"退回",url:"http://127.0.0.1/退回"},
        //                 {name:"转派",url:"http://127.0.0.1/转派"}
        //             ],
        //             urgent: '',
        //             statusColor: '',
        //             titleIcon: '',
        //             titleColor: '',
        //         },
        //         {
        //             operdate: '2015-12-01&nbsp;11:55',
        //             istrap: '0',
        //             state: '已接收(进行中)',
        //             trno: 'BX2015060405',
        //             projectname: '广州市粤商投资有限公司',
        //             addr: '广州市白云区人和龙苑小区',
        //             checkuser:'李小明',
        //             nextstate: [
        //                 {name:"完成",url:"http://127.0.0.1/完成"}
        //             ],
        //             urgent: '',
        //             statusColor: '',
        //             titleIcon: '',
        //             titleColor: '',
        //         }
        //     ]);
        //         this.setData(d);
        //         onSuccess(d.length);
                }
    },

    updateDat: function(onSuccess, onFailure, parm) {

    },

    filteDat: function(parm) {
        this.clearFilter();

        if(parm!=='') {
            this.filterBy(function(item) {
                var s = item.get('projectname') + ' ' + item.get('addr') + ' ' +
                    item.get('checkuser') ;
                return (s.toUpperCase().indexOf(parm.toUpperCase())>=0);
            });
        }
    },

    decoDat: function(data) {
        if(!data) return([]);

        var statusArr = [];
        /*
        statusArr['0'  ]= { text:'待分配', color:'green' };
        statusArr['103']= { text:'关闭',   color:'gray' };
        statusArr['104']= { text:'退单',   color:'red' };
        statusArr['201']= { text:'待接收', color:'orange' };
        statusArr['202']= { text:'未出发', color:'green' };
        statusArr['301']= { text:'路途中', color:'blue' };
        statusArr['302']= { text:'维修中', color:'purple' };
        statusArr['303']= { text:'救援中', color:'purple' };
        statusArr['401']= { text:'已完成', color:'black' };
        */
        statusArr['待分配']= { code:'0',   color:'purple' };
        statusArr['关闭']= { code:'103', color:'gray' };
        statusArr['已退回']= { code:'104', color:'red' };
        statusArr['未接收']= { code:'201', color:'green' };
        statusArr['维修中']= { code:'202', color:'orange' };
        //statusArr['路途中']= { code:'301', color:'blue' };
        //statusArr['维修中']= { code:'302', color:'purple' };
        //statusArr['救援中']= { code:'303', color:'purple' };
        statusArr['已完工']= { code:'401', color:'black' };


        // urgent、statusColor、titleIcon、titleColor 根据istrap显示:
        // urgent 		: 紧急的角标
        // statusColor	: 状态的颜色
        // titleIcon	: 标题的图标
        // titleColor	: 标题的颜色

        for(var i=0;i<data.length; i++) {
            var state = data[i].state;
            if(!statusArr[state]) {
                Ext.toast('sx_sxlist 未知状态：' + state);
                continue;
            }

            data[i].operdate = data[i].operdate.split(' ')[0];
            data[i].titleColor  = 'liftnet-fontColor-' + statusArr[state].color;
            data[i].statusColor = 'liftnet-fontColor-' + statusArr[state].color;
            //data[i].state       = statusArr[state].text;

            if(data[i].istrap==='1') {
                if(state==='待分配'||
                   state==='已退回'||
                   state==='未接收'||
                   state==='维修中'//||
                   //state==='路途中'||
                   /*state==='救援中'*/) {
                    data[i].urgent = '<div class="liftnet-remindBg liftnet-remindBg-red"></div><div class="liftnet-remind liftnet-font-size12">急</div>';
                }
                data[i].titleIcon = '<i class="ln ln-stranded"></i> ';
                data[i].istrap = '<span class="liftnet-font-size14">(困人)</span>';
            } else {
                data[i].titleIcon = '<i class="ln ln-repair"></i> ';
                data[i].istrap = '';
            }
        }

        return(data);
    }

});