/*
 * File: app/controller/Admin/AdmMonitorController.js
 *
 * This file was generated by Sencha Architect version 3.5.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('liftnet.controller.Admin.AdmMonitorController', {
    extend: 'Ext.app.Controller',

    config: {
        control: {
            "panel#AdmMonitorPersonnelList": {
                show: 'onAdmMonitorPersonnelListShow'
            },
            "panel#AdmMonitorPersonnelInformation": {
                show: 'onAdmMonitorPersonnelInformationShow'
            },
            "panel#AdmMonitorElevatorList": {
                show: 'onAdmMonitorElevatorListShow'
            },
            "button#AdmMonitor_BtnPeople": {
                tap: 'onAdmMonitor_BtnPeopleTap'
            },
            "button#AdmMonitor_BtnLift": {
                tap: 'onAdmMonitor_BtnLiftTap'
            },
            "list#AdmMonitorPersonnelList_ListDetailed": {
                itemtap: 'onAdmMonitorPersonnelList_ListDetailedItemTap'
            },
            "list#AdmMonitorElevatorList_ListDetailed": {
                itemtap: 'onAdmMonitorElevatorList_ListDetailedItemTap'
            },
            "panel#AdmMonitorElevatorDetail": {
                show: 'onAdmMonitorElevatorDetailShow'
            },
            "button#AdmMonitorElevatorDetail_BtnReturn": {
                tap: 'onAdmMonitorElevatorDetail_BtnReturnTap'
            },
            "button#AdmMonitorElevatorList_BtnReturn": {
                tap: 'onAdmMonitorElevatorList_BtnReturnTap'
            },
            "button#AdmMonitorPersonnelInformation_BtnReturn": {
                tap: 'onAdmMonitorPersonnelInformation_BtnReturnTap'
            },
            "button#AdmMonitorPersonnelList_BtnReturn": {
                tap: 'onAdmMonitorPersonnelList_BtnReturnTap'
            },
            "container#AdmHome_Map": {
                painted: 'onAdmHome_MapPainted'
            },
            "container#AdmHome_MapPeople": {
                painted: 'onAdmHome_MapPeoplePainted'
            },
            "container#AdmHome_MapElevator": {
                painted: 'onAdmHome_MapElevatorPainted'
            }
        }
    },

    onAdmMonitorPersonnelListShow: function(component, eOpts) {
        // 人员列表
        Ext.getCmp('AdmMonitorPersonnelList_ListDetailed').getStore().loadDat(
            function() {},
            function() {},
            null
        );
    },

    onAdmMonitorPersonnelInformationShow: function(component, eOpts) {
        // 人员详细
        Ext.getCmp('AdmMonitorPersonnelInformation_ListDetailed').getStore().loadDat(
            function() {},
            function() {},
            null
        );

        var record = component.initialConfig.parm.record;
        var namephone = record.get('username') + '&nbsp;&nbsp;' + record.get('phone');
        var status = record.get('status') + '&nbsp;' + '<i class="fa fa-circle-o"></i>';
        var color = record.get('statuscolor');
        var addr = record.get('addr');
        var time = record.get('time');
        var icon = record.get('statusicon');

        Ext.getCmp('AdmMonitorPersonalInfo_LblNamePhone').setHtml(namephone);
        Ext.getCmp('AdmMonitorPersonalInfo_LblAddr').setHtml(addr);
        Ext.getCmp('AdmMonitorPersonalInfo_LblTime').setHtml(time);

        var cls = color + ' liftnet-font-size12 liftnet-font-right';
        Ext.getCmp('AdmMonitorPersonalInfo_LblStatus').setHtml(status);
        Ext.getCmp('AdmMonitorPersonalInfo_LblStatus').setCls(cls);
    },

    onAdmMonitorElevatorListShow: function(component, eOpts) {
        // 电梯列表
        Ext.getCmp('AdmMonitorElevatorList_ListDetailed').getStore().loadDat(
            function() {},
            function() {},
            null
        );
    },

    /* ********** 实时监控 ********** */
    onAdmMonitor_BtnPeopleTap: function(button, e, eOpts) {
        //查看所有人员
        viewUtil.goNext('Admin.AdmMonitorPersonnelList');
    },

    onAdmMonitor_BtnLiftTap: function(button, e, eOpts) {
        //查看所有电梯
        viewUtil.goNext('Admin.AdmMonitorElevatorList');
    },

    onAdmMonitorPersonnelList_ListDetailedItemTap: function(dataview, index, target, record, e, eOpts) {
        //人员列表-跳转-人员详细
        viewUtil.goNext('Admin.AdmMonitorPersonnelInformation', {record: record});
    },

    onAdmMonitorElevatorList_ListDetailedItemTap: function(dataview, index, target, record, e, eOpts) {
        //电梯列表-跳转-电梯详细
        var id = record.get('prodid');
        viewUtil.goNext('Admin.AdmMonitorElevatorDetail', {id: id});
    },

    onAdmMonitorElevatorDetailShow: function(component, eOpts) {
        //电梯详细资料
        var id = component.initialConfig.parm.id;
        var store = dataUtil.createStore('common_eleinfo');
        store.loadDat(
            function() {
                store.filteDat(id);
                if(store.getData().length===1) {
                    Ext.getCmp('form_common_eleinfo').setRecord(store.getAt(0));
                    Ext.getCmp('AdmMonitorElevatorDetail_LblName').setHtml(store.getAt(0).get('UserUnitId'));
                    Ext.getCmp('AdmMonitorElevatorDetail_LblId').setHtml(store.getAt(0).get('UserAddress'));
                } else {
                    Ext.toast('没有找到电梯资料');
                }
            },
            function() {
                Ext.toast('没有找到电梯资料');
                viewUtil.goLast();
            },
            id
        );
    },

    onAdmMonitorElevatorDetail_BtnReturnTap: function(button, e, eOpts) {
        viewUtil.goLast();
    },

    onAdmMonitorElevatorList_BtnReturnTap: function(button, e, eOpts) {
        viewUtil.goLast();
    },

    onAdmMonitorPersonnelInformation_BtnReturnTap: function(button, e, eOpts) {
        viewUtil.goLast();
    },

    onAdmMonitorPersonnelList_BtnReturnTap: function(button, e, eOpts) {
        viewUtil.goLast();
    },

    /* 首页地图 */
    onAdmHome_MapPainted: function(element, eOpts) {
        map.create('admHomeMap');
        this.doAdm_MarkPerson('admHomeMap');
    },

    /* 人员地图 */
    onAdmHome_MapPeoplePainted: function(element, eOpts) {
        map.create('peopleMap');
        this.doAdm_MarkPerson('peopleMap');
    },

    /* 电梯地图 */
    onAdmHome_MapElevatorPainted: function(element, eOpts) {
        map.create('elevatorMap');
        this.doAdm_MarkLift('elevatorMap');
    },

    /* 标注人员 */
    doAdm_MarkPerson: function(mapid) {
        var amap = map.lookup(mapid);
        if(!amap) return;

        var p = map.getLocation();
        var content = '<div style="color:#888;font-size:0.9em"><br />' + p.addr + '</div>';
        map.addMarker(amap, {
            lng:p.lng, lat: p.lat,
            img: 'resources/images/marker_me.png',
            sizeX: 65, sizeY: 65,
            offsetX: 13, offsetY: 31,
            title: '我的位置', content: content
        });

        // 标注其他人位置
        var store = dataUtil.createStore('ss_guserlist');
        store.loadDat(
            function() {
                store.getData().each(function(r) {
                    var lng = r.get('lon');
                    var lat = r.get('lat');
                    var name = r.get('username');
                    var addr = r.get('addr');
                    var status = r.get('status');
                    var phone = r.get('phone');
                    var title = name + '&nbsp;' + phone;
                    var content = '<div style="color:#888;font-size:0.9em">' + addr +
                                  '<br>' + status + '</div>';
                    map.addMarker(amap, {
                        lng: lng, lat: lat,
                        img: 'resources/images/marker_staff.png',
                        sizeX: 65, sizeY: 65,
                        offsetX: 13, offsetY: 31,
                        title: title, content: content,
                        infoW: 220, infoH:60
                    });
                });
            },
            Ext.emptyFn
        );
    },

    /* 标注电梯 */
    doAdm_MarkLift: function(mapid) {
        var amap = map.lookup(mapid);
        if(!amap) return;

        var store = dataUtil.createStore('ss_elesitulation');
        store.loadDat(
            function() {
                store.getData().each(function(r) {
                    var lng = r.get('lon');
                    var lat = r.get('lat');
                    var name = r.get('unitname');
                    var addr = r.get('addr');
                    var prodid = r.get('prodid');
                    var elevatorid = r.get('elevatorid');
                    var FSD = r.get('FSD');
                    var lastfinishtime = r.get('lastfinishtime');

                    var title = '<div style="font-size:0.9em;">注册码：' + prodid + '</div>';
                    var content = '<hr noshade style="border:none;background-color:#eee;height:1px;width:100%;" />' +
                                  '<div style="font-size:0.9em;">' +
                                  '电梯型号：' + elevatorid + '<br>' +
                                  '层／站　：' + FSD + '<br>' +
                                  '保养日期：' + lastfinishtime + '<br>' +
                                  '<div style="color:#888;">' +
                                  name + '<br>' +
                                  addr + '<br></div></div>';
                    map.addMarker(amap, {
                        lng: lng, lat: lat,
                        img: 'resources/images/marker_lift.png',
                        sizeX: 65, sizeY: 65,
                        offsetX: 13, offsetY: 31,
                        title: title, content: content,
                        infoW: 250, infoH:140
                    });
                });
            },
            Ext.emptyFn
        );
    }

});