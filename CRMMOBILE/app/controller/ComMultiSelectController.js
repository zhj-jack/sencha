/*
 * File: app/controller/ComMultiSelectController.js
 *
 * This file was generated by Sencha Architect version 3.5.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('liftnet.controller.ComMultiSelectController', {
    extend: 'Ext.app.Controller',

    config: {
        control: {
            "panel#ComMultiSelect": {
                show: 'onComMultiSelectShow'
            },
            "button#ComMultiSelect_BtnSearch": {
                tap: 'onComMultiSelect_BtnSearchTap'
            },
            "button#ComMultiSelect_BtnSelectAll": {
                tap: 'onComMultiSelect_BtnSelectAllTap'
            },
            "button#ComMultiSelect_BtnMore": {
                tap: 'onComMultiSelect_BtnMoreTap'
            },
            "button#ComMultiSelect_BtnOK": {
                tap: 'onComMultiSelect_BtnOKTap'
            },
            "button#ComMultiSelect_BtnReturn": {
                tap: 'onComMultiSelect_BtnReturnTap'
            }
        }
    },

    onComMultiSelectShow: function(component, eOpts) {
        view = component;

        // 初始化搜索栏
        var textfield = view.initialConfig.parm.textfield;
        var label = textfield.getLabel();
        if(view.initialConfig.parm.allowsearch) {
            var field = Ext.getCmp('ComMultiSelect_FldKeyword');
            field.setPlaceHolder(label + '...');
            field.setValue(textfield.getValue());
            Ext.getCmp('ComMultiSelect_Tbar').setTitle('');
            Ext.getCmp('ComMultiSelect_FldKeyword').setHidden(false);
            Ext.getCmp('ComMultiSelect_BtnSearch').setHidden(false);
        } else {
            Ext.getCmp('ComMultiSelect_Tbar').setTitle(label);
            Ext.getCmp('ComMultiSelect_FldKeyword').setHidden(true);
            Ext.getCmp('ComMultiSelect_BtnSearch').setHidden(true);
        }
        if(view.initialConfig.parm.allowselectall){
            Ext.getCmp('ComMultiSelect_BtnSelectAll').setHidden(false);
            Ext.getCmp('ComMultiSelect_Space').setHidden(view.initialConfig.parm.allowsearch);
        }

        // 初始化操作按钮
        // Ext.getCmp('ComMultiSelect_BtnMore').setHidden(!view.initialConfig.parm.paging);
        // Ext.getCmp('ComMultiSelect_BtnMore').setDisabled(true);

        Ext.getCmp('ComMultiSelect_BtnMore').setHidden(!view.initialConfig.parm.paging);
        var more = view.initialConfig.parm.paging&&!view.initialConfig.parm.allowsearch;
        Ext.getCmp('ComMultiSelect_BtnMore').setDisabled(!more);

        // 初始化数据列表
        var list = Ext.getCmp('ComMultiSelect_List');
        list.setItemTpl(view.initialConfig.parm.itemtpl);

        // 创建或调出store
        var storeid = view.initialConfig.parm.storeid;
        var store = dataUtil.createStore(storeid);
        store.setData([]);
        list.setStore(store);

        // 无需搜索时马上载入数据
        if(!view.initialConfig.parm.allowsearch) {
            loadMask.show();
            store.loadDat(
                function(n) {
                    var filter = view.initialConfig.parm.filterData;
                    if(filter){
                        store.filteDat(filter.field,filter.value);
                    }
                    loadMask.hide();
                },
                function() {
                    loadMask.hide();
                },
                view.initialConfig.parm.storeparm
            );
        }
    },

    onComMultiSelect_BtnSearchTap: function(button, e, eOpts) {
        // 开始搜索
        var view = Ext.getCmp('ComMultiSelect');
        var text = Ext.getCmp('ComMultiSelect_FldKeyword').getValue();

        view.initialConfig.parm.storeparm =
            view.initialConfig.parm.fnSetFilter(view.initialConfig.parm.storeparm, text);
        view.initialConfig.parm.storeparm.pageno = 0;

        var store = Ext.getCmp('ComMultiSelect_List').getStore();
        store.setData([]);
        loadMask.show();
        store.loadDat(
            function(n) {
                if(view.initialConfig.parm.paging) {
                    view.initialConfig.parm.storeparm.pageno =
                        view.initialConfig.parm.storeparm.pageno + n;
                    Ext.getCmp('ComMultiSelect_BtnMore').setDisabled(false);
                }
                loadMask.hide();
            },
            function() {
                loadMask.hide();
            },
            view.initialConfig.parm.storeparm
        );
    },

    onComMultiSelect_BtnSelectAllTap: function(button, e, eOpts) {
        var list = Ext.getCmp('ComMultiSelect_List');
        if(list.getSelectionCount()<list.getStore().getAllCount())
        {
            list.selectAll(true);//全选
        }else{
            list.deselectAll(true);//全不选
        }

    },

    onComMultiSelect_BtnMoreTap: function(button, e, eOpts) {
        var store = Ext.getCmp('ComMultiSelect_List').getStore();
        var record = store.getAt(store.getAllCount() - 1);
        loadMask.show();
        store.loadDat(
            function(n) {
                Ext.getCmp('ComMultiSelect_List').scrollToRecord(record);
                view.initialConfig.parm.storeparm.curpagenum =
                    view.initialConfig.parm.storeparm.curpagenum + 1;
                var filter = view.initialConfig.parm.filterData;
                    if(filter){
                        store.filteDat(filter.field,filter.value);
                    }
                if(n===0){
                    Ext.toast('没有更多数据');
                }

                loadMask.hide();
            },
            function() {
                loadMask.hide();
            },
            view.initialConfig.parm.storeparm
        );
    },

    onComMultiSelect_BtnOKTap: function(button, e, eOpts) {
        // 返回数据
        var view = Ext.getCmp('ComMultiSelect');
        var fn = view.initialConfig.parm.fnSelected;
        var list = Ext.getCmp('ComMultiSelect_List');
        var text = Ext.getCmp('ComMultiSelect_FldKeyword').getValue().trim();
        var ret = list.getSelection();

        if(ret.length===0) {
            if(!view.initialConfig.parm.allowedit || text==='') {
                Ext.toast('请填写或选择资料！');
                return;
            }
            ret = text;
        }

        // form-field不接受即时的值变化，因此需要延时回调赋值方法
        var task = Ext.create('Ext.util.DelayedTask', function() {
            fn(ret);
            task.cancel();
        });
        task.delay(100);

        viewUtil.goLast();
    },

    onComMultiSelect_BtnReturnTap: function(button, e, eOpts) {
        viewUtil.goLast();
    }

});